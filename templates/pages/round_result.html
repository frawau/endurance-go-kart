{% extends "layout/content.html" %}
{% load round_tags %}

{% block main_content %}
<div class="container">
    <h1>Round Result</h1>

    <form method="get" id="round-form">
        <div class="form-group">
            <label for="round-select">Select Round:</label>
            <select class="form-control" id="round-select" name="round_id" onchange="this.form.submit()">
                {% for championship_name, championship_rounds in rounds_by_championship.items %}
                    <optgroup label="{{ championship_name }}">
                        {% for round in championship_rounds %}
                            <option value="{{ round.id }}" {% if round.id == selected_round_id %}selected{% endif %}>
                                {{ round.name }} ({{ round.start|date:"Y-m-d" }})
                            </option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>
    </form>

    {% if races_data %}
    <div class="races-container mt-4">
        {% for race_data in races_data %}
        <div class="race-section mb-3" id="race-section-{{ race_data.race.id }}">
            <div class="race-header d-flex align-items-center justify-content-between"
                 data-bs-toggle="collapse"
                 data-bs-target="#race-body-{{ race_data.race.id }}"
                 aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                 role="button">
                <div class="d-flex align-items-center gap-2">
                    <span class="collapse-arrow {% if forloop.first %}open{% endif %}">▶</span>
                    <span class="race-title">{{ race_data.race.get_race_type_display }}</span>
                </div>
                <span class="race-badge
                    {% if race_data.is_live %}badge-live
                    {% elif race_data.is_finished %}badge-finished
                    {% else %}badge-pending{% endif %}">
                    {% if race_data.is_live %}LIVE
                    {% elif race_data.is_finished %}FINISHED
                    {% else %}NOT STARTED{% endif %}
                </span>
            </div>

            <div class="collapse {% if forloop.first %}show{% endif %}" id="race-body-{{ race_data.race.id }}">
                <div class="race-body">
                    {% if race_data.race.started %}
                    <table class="table result-table mb-0" data-race-id="{{ race_data.race.id }}">
                        <thead>
                            <tr class="header-standings">
                                <th class="col-strip"></th>
                                <th>Pos</th>
                                <th>#</th>
                                <th>Team</th>
                                <th>Laps</th>
                                <th>Best Lap</th>
                                <th>Gap</th>
                            </tr>
                            <tr class="header-laps" style="display:none;">
                                <th class="col-strip"></th>
                                <th>Driver</th>
                                <th>Lap #</th>
                                <th>Lap Time</th>
                                <th>Diff</th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in race_data.standings %}
                            <tr class="team-row {% cycle 'team-odd' 'team-even' as row_colors %}
                                {% if entry.position == 1 %}pos-gold
                                {% elif entry.position == 2 %}pos-silver
                                {% elif entry.position == 3 %}pos-bronze
                                {% endif %}"
                                data-team-id="{{ entry.team_id }}"
                                data-race-id="{{ race_data.race.id }}">
                                <td class="col-strip"></td>
                                <td><span class="expand-icon">▶</span>{{ entry.position }}</td>
                                <td>{{ entry.team_number }}</td>
                                <td>{{ entry.team_name }}</td>
                                <td>{{ entry.laps_completed }}</td>
                                <td>{{ entry.best_lap_time_formatted }}</td>
                                <td>{{ entry.gap_ahead }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="not-started-msg">Race not yet started</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif selected_round %}
    <div class="alert alert-info">No races found for this round.</div>
    {% else %}
    <div class="alert alert-info">No round selected.</div>
    {% endif %}
</div>

<script>
const liveRaces = [
    {% for race_data in races_data %}{% if race_data.is_live %}{{ race_data.race.id }},{% endif %}{% endfor %}
];
</script>
{% endblock main_content %}

{% block extra_js %}
<style>
    /* ── Global ── */
    h1 {
        color: #e6e6fa !important;
        margin-bottom: 25px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    #round-form label { color: #e6e6fa !important; font-weight: 500; }
    #round-select {
        color: #e6e6fa !important;
        background-color: rgba(40,40,60,0.9) !important;
        border: 1px solid rgba(100,100,140,0.4);
        border-radius: 4px;
        padding: 8px 12px;
    }
    #round-select option, #round-select optgroup {
        color: #e6e6fa !important;
        background-color: #2d2d3d !important;
    }
    body .card-body .form-control,
    body .card .card-body .form-control,
    body .form-group .form-control { color: #e6e6fa !important; }

    /* ── Race section card ── */
    .race-section { border-radius: 6px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .race-header {
        background-color: rgba(30,30,40,0.9);
        color: #e6e6fa;
        padding: 12px 16px;
        cursor: pointer;
        user-select: none;
        border-bottom: 2px solid rgba(80,80,100,0.6);
    }
    .race-header:hover { background-color: rgba(50,50,70,0.9); }
    .race-title { font-weight: 600; letter-spacing: 0.5px; font-size: 1rem; }

    .collapse-arrow {
        display: inline-block;
        transition: transform 0.25s ease;
        font-size: 0.75rem;
    }
    .collapse-arrow.open { transform: rotate(90deg); }

    .race-badge {
        font-size: 0.75rem; font-weight: 700;
        padding: 3px 10px; border-radius: 12px; letter-spacing: 0.5px;
    }
    .badge-live     { background-color: #ff5252; color: #fff; }
    .badge-finished { background-color: #4caf50; color: #fff; }
    .badge-pending  { background-color: rgba(120,120,140,0.7); color: #e6e6fa; }

    /* ── Table ── */
    .race-body { background-color: rgba(40,40,50,0.85); }
    .not-started-msg { color: rgba(200,200,220,0.6); font-style: italic; padding: 16px 20px; }
    .result-table { background-color: rgba(40,40,50,0.85); margin: 0; }

    .result-table th {
        background-color: rgba(30,30,40,0.9);
        color: #e6e6fa !important;
        font-weight: 600;
        letter-spacing: 0.5px;
        border-bottom: 2px solid rgba(80,80,100,0.6);
        padding: 10px 15px;
    }
    .result-table td {
        color: #e6e6fa !important;
        border-top: 1px solid rgba(80,80,100,0.3);
        padding: 9px 15px;
    }

    /* ── Colour-strip (8 px, same as round_info) ── */
    .col-strip {
        width: 8px !important; min-width: 8px !important; max-width: 8px !important;
        padding: 0 !important; border-right: none !important;
    }

    /* ── Standings rows (same palette as round_info team-member rows) ── */
    .result-table tr.team-odd  { background-color: rgba(90,50,70,0.8); }
    .result-table tr.team-even { background-color: rgba(50,70,100,0.8); }
    .result-table tr.team-row  { cursor: pointer; transition: background-color 0.2s ease; }
    .result-table tr.team-row:hover td { filter: brightness(1.18); }


    /* ── Lap rows (same palette as round_info session rows) ── */
    .result-table tr.lap-odd  { background-color: rgba(70,70,80,0.7); }
    .result-table tr.lap-even { background-color: rgba(80,80,90,0.7); }
    .result-table tr.lap-row  { opacity: 0; transition: opacity 0.2s ease-out; }
    .result-table tr.lap-row.show { opacity: 1; }

    /* ── Expand arrow on team rows ── */
    .expand-icon {
        display: inline-block;
        width: 14px;
        margin-right: 5px;
        font-size: 0.65rem;
        transition: transform 0.2s ease;
    }
    .result-table tr.team-row.expanded .expand-icon { transform: rotate(90deg); }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {

    /* ── Race section accordion + collapse arrows ── */
    const allRaceCollapses = Array.from(
        document.querySelectorAll('.race-section .collapse')
    );

    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function (hdr) {
        const target = document.querySelector(hdr.getAttribute('data-bs-target'));
        const arrow  = hdr.querySelector('.collapse-arrow');
        if (!target || !arrow) return;

        target.addEventListener('show.bs.collapse', () => {
            arrow.classList.add('open');
            /* Close every other race section */
            allRaceCollapses.forEach(other => {
                if (other !== target && other.classList.contains('show')) {
                    /* Also collapse any expanded team inside before hiding */
                    const otherTable = other.querySelector('.result-table');
                    if (otherTable) {
                        otherTable.querySelectorAll('.team-row.expanded').forEach(r => {
                            collapseTeam(otherTable, r);
                        });
                    }
                    bootstrap.Collapse.getInstance(other)?.hide();
                }
            });
        });
        target.addEventListener('hide.bs.collapse', () => arrow.classList.remove('open'));
    });

    /* ── Initialise each race table ── */
    document.querySelectorAll('.result-table').forEach(initTable);

    /* ─────────────────────────────── */
    function initTable(table) {
        const raceId    = table.dataset.raceId;
        const hStandings = table.querySelector('.header-standings');
        const hLaps      = table.querySelector('.header-laps');
        const lapCache   = {};   // teamId → true once rows injected
        const fetching   = {};   // teamId → true during fetch

        /* Header switching */
        function showHeader(which) {
            const showLaps = (which === 'laps');
            hLaps.style.display      = showLaps ? '' : 'none';
            hStandings.style.display = showLaps ? 'none' : '';
        }

        table.addEventListener('mouseleave', () => showHeader('standings'));
        table.addEventListener('mouseover', function (e) {
            if (e.target.closest('.lap-row'))  showHeader('laps');
            else if (e.target.closest('.team-row')) showHeader('standings');
        });

        /* Click via event delegation — works for initial AND live-updated rows */
        table.querySelector('tbody').addEventListener('click', function (e) {
            const row = e.target.closest('.team-row');
            if (!row) return;

            const teamId = row.dataset.teamId;
            const isOpen = row.classList.contains('expanded');

            /* Close other expanded teams */
            table.querySelectorAll('.team-row.expanded').forEach(other => {
                if (other !== row) collapseTeam(table, other);
            });

            if (isOpen) {
                collapseTeam(table, row);
            } else {
                expandTeam(table, row, raceId, teamId, lapCache, fetching, showHeader);
            }
        });
    }

    /* ── Collapse a team ── */
    function collapseTeam(table, teamRow) {
        const teamId = teamRow.dataset.teamId;
        teamRow.classList.remove('expanded');
        table.querySelectorAll(`.lap-row[data-team-id="${teamId}"]`).forEach(r => {
            r.classList.remove('show');
            setTimeout(() => { if (r.parentNode) r.style.display = 'none'; }, 220);
        });
    }

    /* ── Expand a team ── */
    function expandTeam(table, teamRow, raceId, teamId, lapCache, fetching, showHeader) {
        teamRow.classList.add('expanded');

        if (lapCache[teamId]) {
            /* Already in DOM — just unhide */
            table.querySelectorAll(`.lap-row[data-team-id="${teamId}"]`).forEach(r => {
                r.style.display = 'table-row';
                requestAnimationFrame(() => r.classList.add('show'));
            });
            return;
        }

        if (fetching[teamId]) return;
        fetching[teamId] = true;

        /* Loading placeholder */
        const placeholder = makePlaceholder(teamId, 'Loading laps…');
        teamRow.insertAdjacentElement('afterend', placeholder);

        fetch(`/api/race/${raceId}/team/${teamId}/laps/`)
            .then(r => r.json())
            .then(data => {
                placeholder.remove();
                fetching[teamId] = false;
                lapCache[teamId] = true;

                if (!data.laps || data.laps.length === 0) {
                    const empty = makePlaceholder(teamId, 'No laps recorded.');
                    teamRow.insertAdjacentElement('afterend', empty);
                    requestAnimationFrame(() => empty.classList.add('show'));
                    return;
                }

                /* Build rows and insert them after teamRow in correct order.
                   We insert each row after teamRow (insertAdjacentElement('afterend'))
                   in reverse so the final order is ascending lap number. */
                for (let i = data.laps.length - 1; i >= 0; i--) {
                    const lap = data.laps[i];
                    const tr = document.createElement('tr');
                    tr.className = `lap-row ${i % 2 === 0 ? 'lap-odd' : 'lap-even'}`;
                    tr.dataset.teamId = teamId;
                    tr.style.display = 'table-row';
                    tr.innerHTML =
                        `<td class="col-strip"></td>` +
                        `<td style="color:rgba(220,200,240,0.9)">${escHtml(lap.driver)}</td>` +
                        `<td>${lap.lap_number}</td>` +
                        `<td>${escHtml(lap.lap_time)}</td>` +
                        `<td style="color:${diffColor(lap.diff)}">${escHtml(lap.diff)}</td>` +
                        `<td></td>`;
                    teamRow.insertAdjacentElement('afterend', tr);
                }

                /* Fade in */
                requestAnimationFrame(() => {
                    table.querySelectorAll(`.lap-row[data-team-id="${teamId}"]`)
                         .forEach(r => r.classList.add('show'));
                });

                showHeader('laps');
            })
            .catch(() => {
                placeholder.remove();
                fetching[teamId] = false;
                teamRow.classList.remove('expanded');
            });
    }

    function makePlaceholder(teamId, msg) {
        const tr = document.createElement('tr');
        tr.className = 'lap-row show';
        tr.dataset.teamId = teamId;
        tr.innerHTML = `<td class="col-strip"></td><td colspan="6" style="color:rgba(200,200,220,0.6);font-style:italic;">${msg}</td>`;
        return tr;
    }

    function diffColor(diff) {
        if (!diff || diff === '—') return 'inherit';
        return diff.startsWith('+') ? '#ff8080' : '#80e080';
    }

    function escHtml(s) {
        return String(s ?? '')
            .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    /* ── WebSocket live updates ── */
    liveRaces.forEach(function (raceId) {
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsScheme}://${window.location.host}/ws/leaderboard/${raceId}/`);

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);

            if (data.type === 'standings_update') {
                const table = document.querySelector(`.result-table[data-race-id="${raceId}"]`);
                if (!table) return;
                const tbody = table.querySelector('tbody');

                /* Replace only team-row elements; keep any expanded lap rows */
                tbody.querySelectorAll('.team-row').forEach(r => r.remove());

                let odd = true;
                const rows = data.standings.map(entry => {
                    const tr = document.createElement('tr');
                    let pos = '';
                    if (entry.position === 1) pos = 'pos-gold';
                    else if (entry.position === 2) pos = 'pos-silver';
                    else if (entry.position === 3) pos = 'pos-bronze';
                    tr.className = `team-row ${odd ? 'team-odd' : 'team-even'} ${pos}`;
                    tr.dataset.teamId = entry.team_id;
                    tr.dataset.raceId = raceId;
                    tr.innerHTML =
                        `<td class="col-strip"></td>` +
                        `<td><span class="expand-icon">▶</span>${entry.position}</td>` +
                        `<td>${entry.team_number}</td>` +
                        `<td>${escHtml(entry.team_name)}</td>` +
                        `<td>${entry.laps_completed ?? '—'}</td>` +
                        `<td>${entry.best_lap_time_formatted ?? '—'}</td>` +
                        `<td>${entry.gap_ahead ?? '—'}</td>`;
                    odd = !odd;
                    return tr;
                });

                /* Insert team rows before the first lap-row (if any), else prepend */
                const firstLap = tbody.querySelector('.lap-row');
                if (firstLap) {
                    rows.forEach(r => tbody.insertBefore(r, firstLap));
                } else {
                    rows.forEach(r => tbody.appendChild(r));
                }

            } else if (data.type === 'race_ended') {
                const badge = document.querySelector(`#race-section-${raceId} .race-badge`);
                if (badge) {
                    badge.textContent = 'FINISHED';
                    badge.className = 'race-badge badge-finished';
                }
            }
        };
    });
});
</script>
{% endblock extra_js %}
